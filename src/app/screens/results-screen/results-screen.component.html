<spinner [isVisible]="loading"></spinner>

<div class="container">
  <!-- SIDEBAR -->
  <aside class="sidebar" *ngIf="!showOnlyChosen">
    <!-- Meal Plan Section -->
    <div class="section">
      <h3 (click)="toggleSection('mealPlan')">
        Meal Plan
        <span class="toggle-icon">{{
          isSectionOpen("mealPlan") ? "‚àí" : "+"
        }}</span>
      </h3>
      <div *ngIf="isSectionOpen('mealPlan')">
        <div *ngFor="let day of daysList" class="day-block">
          <h4 (click)="selectDay(day)" [class.active]="selectedDay === day">
            {{ day }}
          </h4>
          <ul *ngIf="selectedDay === day">
            <li
              *ngFor="let category of dailyCategories[day]"
              [class.active]="selectedCategory === category"
              (click)="selectCategory(category)"
            >
              {{ "categories." + category | translate }}
            </li>
          </ul>
        </div>
      </div>
    </div>
      <div
        class="budget-container"
        [style.background]="getBudgetColorAlpha()"
        *ngIf="store.getBudget()"
      >
        <div class="budget-header">
          <span>Budget: ‚Ç¨{{ store.getBudget() | number : "1.2-2" }}</span>
          <span>Remaining: ‚Ç¨{{ getRemainingBudget() | number : "1.2-2" }}</span>
        </div>

        <div class="budget-bar">
          <div
            class="budget-fill"
            [style.width.%]="getBudgetProgress()"
            [ngClass]="getBudgetColor()"
          ></div>
        </div>

        <div class="budget-footer">
          Spent: ‚Ç¨{{ totalChosenPrice | number : "1.2-2" }}
        </div>
      </div>
    <!-- Filters Section -->
    <div class="section">
      <h3 (click)="toggleSection('filters')">
        Filters
        <span class="toggle-icon">{{
          isSectionOpen("filters") ? "‚àí" : "+"
        }}</span>
      </h3>

      <div class="filters" *ngIf="isSectionOpen('filters')">
        <!-- Price Slider -->
        <div class="filter-group">
          <label>Price (‚Ç¨): {{ priceMin }} ‚Äì {{ priceMax }}</label>
          <ngx-slider
            [(value)]="priceMin"
            [(highValue)]="priceMax"
            [options]="priceOptions"
            (userChangeEnd)="loadProducts()"
          >
          </ngx-slider>
        </div>

        <!-- Kcal Slider -->
        <div class="filter-group">
          <label>Kcal / 100g: {{ kcalMin }} ‚Äì {{ kcalMax }}</label>
          <ngx-slider
            [(value)]="kcalMin"
            [(highValue)]="kcalMax"
            [options]="kcalOptions"
            (userChangeEnd)="loadProducts()"
          >
          </ngx-slider>
        </div>

        <!-- Sort By -->
        <div class="filter-group">
          <label>Sort By</label>
          <select [(ngModel)]="sortBy" (change)="loadProducts()">
            <option value="priceAsc">Price ‚Üë</option>
            <option value="priceDesc">Price ‚Üì</option>
            <option value="kcalAsc">Kcal ‚Üë</option>
            <option value="kcalDesc">Kcal ‚Üì</option>
            <option value="nameAsc">Name A‚ÄìZ</option>
            <option value="nameDesc">Name Z‚ÄìA</option>
          </select>
        </div>
      </div>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="content">
    <!-- PRODUCT GRID -->
    <div class="cart-toggle">
      <button class="cart-btn" (click)="toggleShowChosen()">
        <span class="cart" *ngIf="!showOnlyChosen">üõí ({{ chosenProducts.length }})</span>
        <span *ngIf="showOnlyChosen">‚¨Ö Back to Products</span>
      </button>
    </div>
    <!--Budget Section -->

    <ng-container *ngIf="!showOnlyChosen">
      <!-- <div
        class="budget-container"
        [style.background]="getBudgetColorAlpha()"
        *ngIf="store.getBudget()"
      >
        <div class="budget-header">
          <span>Budget: ‚Ç¨{{ store.getBudget() | number : "1.2-2" }}</span>
          <span>Remaining: ‚Ç¨{{ getRemainingBudget() | number : "1.2-2" }}</span>
        </div>

        <div class="budget-bar">
          <div
            class="budget-fill"
            [style.width.%]="getBudgetProgress()"
            [ngClass]="getBudgetColor()"
          ></div>
        </div>

        <div class="budget-footer">
          Spent: ‚Ç¨{{ totalChosenPrice | number : "1.2-2" }}
        </div>
      </div> -->

      <!-- Kcal Progress -->
      <div
        class="budget-container"
        [style.background]="getKcalColorAlpha()"
        *ngIf="getKcalLimit()"
      >
        <div class="budget-header">
          <span>
            Kcal Goal: {{ getKcalLimit() | number : "1.0-0" }} kcal
            <span
              class="info-icon"
              title="Kcal values are calculated based on 200g of each product, not 100g."
              >‚Ñπ</span
            >
          </span>
          <span
            >Remaining:
            {{
              getKcalLimit() - getTotalChosenKcal() * 2 | number : "1.0-0"
            }}
            kcal</span
          >
        </div>

        <div class="budget-bar">
          <div
            class="budget-fill"
            [style.width.%]="getKcalProgress()"
            [ngClass]="getKcalColor()"
          ></div>
        </div>

        <div class="budget-footer">
          Consumed: {{ getTotalChosenKcal() * 2 | number : "1.0-0" }} kcal
        </div>
      </div>
      <!-- Supermarkets Section -->
      <div class="section">
        <h3 (click)="toggleSection('supermarkets')">
          Supermarkets
          <span class="toggle-icon">{{
            isSectionOpen("supermarkets") ? "‚àí" : "+"
          }}</span>
        </h3>
        <ul *ngIf="isSectionOpen('supermarkets')">
          <li
            *ngFor="let sm of supermarkets"
            (click)="onSelectSupermarket(sm)"
            [class.active]="selectedSupermarket === sm"
          >
            {{ getLocalizedName(sm.name) }}
          </li>
        </ul>
      </div>

      <div *ngIf="!showRecipeCards">
        <div
          *ngIf="products.length === 0 && selectedCategory"
          class="no-products"
        >
          <p>No products available</p>
        </div>

        <div class="product-grid" *ngIf="!loading">
          <div class="card" *ngFor="let product of products">
            <div class="image-wrapper">
              <img
                [src]="'data:image/jpeg;base64,' + product.imageBase64"
                [alt]="product.name"
              />
              <div class="badge" *ngIf="product.discount">SALE</div>
              <button
                class="fav-btn"
                [class.active]="isChosen(product)"
                (click)="toggleChosen(product)"
              >
                ‚ô•
              </button>
            </div>
            <div class="info">
              <h3 class="product-title">{{ product.name }}</h3>
              <p class="product-category">
                {{ "categories." + product.category | translate }}
              </p>
              <mat-divider></mat-divider>
              <p class="kcal" *ngIf="product.kcal !== null && product.kcalIsReal">
                {{ product.kcal }} kcal
              </p>
              <p class="kcal" *ngIf="product.kcal !==  null && !product.kcalIsReal ">
                {{ product.kcal }} kcal *
              </p>
              <p class="price">{{ product.price | currency : "EUR" }}</p>
            </div>
          </div>
        </div>

        <div class="pagination" *ngIf="totalPages > 1">
          <button (click)="prevPage()" [disabled]="currentPage === 1">
            ‚Üê Previous
          </button>
          <span>Page {{ currentPage }} of {{ totalPages }}</span>
          <button (click)="nextPage()" [disabled]="currentPage === totalPages">
            Next ‚Üí
          </button>
        </div>
      </div>
    </ng-container>

    <!-- MEAL PLAN RECIPE CARDS -->

    <!-- ALERT -->
    <app-alert-popup
      *ngIf="showAlert"
      [message]="alertMessage"
      [duration]="alertDuration"
      [status]="alertStatus"
      (close)="closeAlert()"
    ></app-alert-popup>

    <!-- CHOSEN PRODUCTS VIEW -->
    <ng-container *ngIf="showOnlyChosen">
      <h2>Chosen Products</h2>
      <p *ngIf="chosenProducts.length === 0">No chosen products yet.</p>
      <div class="chosen-products-card" *ngIf="chosenProducts.length > 0">
        <div class="product-grid" *ngIf="!loading">
          <div class="card" *ngFor="let product of products">
            <div class="image-wrapper">
              <img
                [src]="'data:image/jpeg;base64,' + product.imageBase64"
                [alt]="product.name"
              />
              <div class="badge" *ngIf="product.discount">SALE</div>
              <button
                class="fav-btn"
                [class.active]="isChosen(product)"
                (click)="toggleChosen(product); loadChosenProducts()"
              >
                ‚ô•
              </button>
            </div>
            <div class="info">
              <h3 class="product-title">{{ product.name }}</h3>
              <p class="product-category" class="category">
                {{ "categories." + product.category | translate }}
              </p>
              <mat-divider></mat-divider>
              <p class="kcal" *ngIf="product.kcal !== null">
                {{ product.kcal }} kcal
              </p>
              <p class="price">{{ product.price | currency : "EUR" }}</p>
            </div>
          </div>
        </div>
      </div>

      <div class="total" *ngIf="chosenProducts.length > 0">
        <strong>Total:</strong> {{ totalChosenPrice | currency : "EUR" }}
      </div>

      <!-- Button to handle recipe logic -->
      <!-- <button
        *ngIf="chosenProducts.length > 0"
        (click)="toggleRecipesSection()"
        class="apply-btn"
      >
        Show Meal Plan Recipes
      </button> -->
      <div  >
        <div class="day-card" *ngFor="let day of daysList">
          <div class="day-header">
            <h3>{{ day }}</h3>
            <button
              class="recipe-btn"
              (click)="generateRecipeForDay(day)"
              [disabled]="loadingRecipes && selectedDayForRecipe === day"
            >
              {{
                loadingRecipes && selectedDayForRecipe === day
                  ? "Generating..."
                  : "Show Recipe"
              }}
            </button>
          </div>

          <div class="chosen-products-card">
            <h4>Ingredients:</h4>
            <ul>
              <li *ngFor="let cp of getProductsForDay(day)">
                {{ cp.product.name }} -
                {{ cp.product.price | currency : "EUR" }}
              </li>
              <li *ngIf="getProductsForDay(day).length === 0">
                No products chosen for this day
              </li>
            </ul>
          </div>

          <div class="recipe-card" *ngIf="recipeDialogData?.day === day">
            <h4>Recipe:</h4>
            <p [innerHTML]="getFormattedRecipe(recipeDialogData?.recipe)"></p>
          </div>
        </div>
      </div>
    </ng-container>
  </main>
</div>
