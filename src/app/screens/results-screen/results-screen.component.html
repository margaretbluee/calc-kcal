<spinner [isVisible]="loading"></spinner>

<div class="container">
  <!-- SIDEBAR -->
  <aside class="sidebar" *ngIf="!showOnlyChosen">
    <!-- Meal Plan Section -->
    <div class="section">
      <h3 (click)="toggleSection('mealPlan')">
        {{'resultsScreen.mealPlan' | translate}}
        <span class="toggle-icon">{{
          isSectionOpen("mealPlan") ? "−" : "+"
        }}</span>
      </h3>
      <div *ngIf="isSectionOpen('mealPlan')">
        <div *ngFor="let day of daysList" class="day-block">
          <h4 (click)="selectDay(day)" [class.active]="selectedDay === day">
            {{ day }}
          </h4>
          <ul *ngIf="selectedDay === day">
            <li
              *ngFor="let category of dailyCategories[day]"
              [class.active]="selectedCategory === category"
              (click)="selectCategory(category)"
            >
              {{ "categories." + category | translate }}
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div
      class="budget-container"
      [style.background]="getBudgetColorAlpha()"
      *ngIf="store.getBudget()"
    >
      <div class="budget-header">
        <span>{{'resultsScreen.budget' | translate }}: €{{ store.getBudget() | number : "1.2-2" }}</span>
        <span>{{'resultsScreen.remaining' | translate }}: €{{ getRemainingBudget() | number : "1.2-2" }}</span>
      </div>

      <div class="budget-bar">
        <div
          class="budget-fill"
          [style.width.%]="getBudgetProgress()"
          [ngClass]="getBudgetColor()"
        ></div>
      </div>

      <div class="budget-footer">
        {{'resultsScreen.spent' | translate }}: €{{ totalChosenPrice | number : "1.2-2" }}
      </div>
    </div>
          <!-- Kcal Progress -->
      <div
        class="budget-container"
        [style.background]="getKcalColorAlpha()"
        *ngIf="getKcalLimit()"
      >
        <div class="budget-header">
          <span>
            {{'resultsScreen.kcalGoal' | translate }}: {{ getKcalLimit() | number : "1.0-0" }} kcal
            <span *ngIf="currentLang === 'en'"
              class="info-icon"
              title="Kcal values are calculated based on 200g of each product, not 100g."
              >ℹ</span>
                          <span *ngIf="currentLang === 'el'"
              class="info-icon"
              title="Οι θερμίδες υπολογίζονται με βάση κατανάλωσης 200γρ. για κάθε επιλεγμένο προϊόν"
              >ℹ</span>
          </span>
          <span
            >{{'resultsScreen.remaining' | translate }}:
            {{ getKcalLimit() - getTotalChosenKcal() * 2 | number : "1.0-0" }}
            kcal</span
          >
        </div>

        <div class="budget-bar">
          <div
            class="budget-fill"
            [style.width.%]="getKcalProgress()"
            [ngClass]="getKcalColor()"
          ></div>
        </div>

        <div class="budget-footer">
          {{'resultsScreen.spent' | translate }}: {{ getTotalChosenKcal() * 2 | number : "1.0-0" }} kcal
        </div>
      </div>
    <!-- Filters Section -->
    <div class="section">
      <h3 (click)="toggleSection('filters')">
        {{'resultsScreen.filters' | translate}}
        <span class="toggle-icon">{{
          isSectionOpen("filters") ? "−" : "+"
        }}</span>
      </h3>

      <div class="filters" *ngIf="isSectionOpen('filters')">
        <!-- Price Slider -->
        <div class="filter-group">
          <label>Price (€): {{ priceMin }} – {{ priceMax }}</label>
          <ngx-slider
            [(value)]="priceMin"
            [(highValue)]="priceMax"
            [options]="priceOptions"
            (userChangeEnd)="loadProducts()"
          >
          </ngx-slider>
        </div>

        <!-- Kcal Slider -->
        <div class="filter-group">
          <label>Kcal / 100g: {{ kcalMin }} – {{ kcalMax }}</label>
          <ngx-slider
            [(value)]="kcalMin"
            [(highValue)]="kcalMax"
            [options]="kcalOptions"
            (userChangeEnd)="loadProducts()"
          >
          </ngx-slider>
        </div>

        <!-- Sort By -->
        <div class="filter-group">
          <label>{{'resultsScreen.sort' | translate}}</label>
          <select [(ngModel)]="sortBy" (change)="loadProducts()">
            <option value="priceAsc">{{'resultsScreen.priceAsc' | translate}}</option>
            <option value="priceDesc">{{'resultsScreen.priceDesc' | translate}}</option>
            <option value="kcalAsc">{{'resultsScreen.kcalAsc' | translate}}</option>
            <option value="kcalDesc">{{'resultsScreen.kcalDesc' | translate}}</option>
            <option value="nameAsc">{{'resultsScreen.nameAsc' | translate}}</option>
            <option value="nameDesc">{{'resultsScreen.priceDesc' | translate}}</option>
          </select>
        </div>
      </div>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="content">
    <!-- PRODUCT GRID -->
       <button *ngIf="showOnlyChosen" class="cart-btn" (click)="toggleShowChosen()">
  
        <span > {{'resultsScreen.productView' | translate}}</span>
      </button>
  
    <ng-container *ngIf="!showOnlyChosen">

      <!-- Supermarkets Section -->
      <div class="section">
        <div class="content-header">

          <div class="supermarkets">
          <h3 (click)="toggleSection('supermarkets')">
            {{'resultsScreen.supermarkets'| translate}}
            <span class="toggle-icon">{{
              isSectionOpen("supermarkets") ? "−" : "+"
            }}</span>
          </h3>

          <ul *ngIf="isSectionOpen('supermarkets')">
            <li
              *ngFor="let sm of supermarkets"
              (click)="onSelectSupermarket(sm)"
              [class.active]="selectedSupermarket === sm"
            >
              {{ getLocalizedName(sm.name) }}
            </li>
          </ul>
          </div>
          <div class="cart-toggle">
            <button class="cart-btn" (click)="toggleShowChosen()">
              <span class="cart" *ngIf="!showOnlyChosen"
                >🛒 ({{ chosenProducts.length }})</span
              >
              <span *ngIf="showOnlyChosen">{{'resultsScreen.productView' | translate}}</span>
            </button>
          </div>
        </div>
      </div>
      <div *ngIf="!showRecipeCards">
        <div
          *ngIf="products.length === 0 && selectedCategory"
          class="no-products"
        >
          <p>{{'resultsScreen.noProducts'| translate}}</p>
        </div>

        <div class="product-grid" *ngIf="!loading">
          <div class="card" *ngFor="let product of products">
            <div class="image-wrapper">
              <img
                [src]="'data:image/jpeg;base64,' + product.imageBase64"
                [alt]="product.name"
              />
              <div class="badge" *ngIf="product.discount">SALE</div>
              <button
                class="fav-btn"
                [class.active]="isChosen(product)"
                (click)="toggleChosen(product);"
              >
                ♥
              </button>
            </div>
            <div class="info">
              <h3 class="product-title">{{ product.name }}</h3>
              <p class="product-category">
                {{ "categories." + product.category | translate }}
              </p>
              <mat-divider></mat-divider>
              <p
                class="kcal"
                *ngIf="product.kcal !== null && product.kcalIsReal"
              >
                {{ product.kcal }} kcal
              </p>
              <p
                class="kcal"
                *ngIf="product.kcal !== null && !product.kcalIsReal"
              >
                {{ product.kcal }} kcal *
              </p>
              <p class="price">{{ product.price | currency : "EUR" }}</p>
            </div>
          </div>
        </div>

        <div class="pagination" *ngIf="totalPages > 1">
          <button (click)="prevPage()" [disabled]="currentPage === 1">
           {{'resultsScreen.paginationPrevious'|translate}}
          </button>
          <span>{{'resultsScreen.page'}} {{ currentPage }} {{'resultsScreen.of'|translate}} {{ totalPages }}</span>
          <button (click)="nextPage()" [disabled]="currentPage === totalPages">
           {{'resultsScreen.paginationNext'|translate}}
          </button>
        </div>
      </div>
    </ng-container>

    <!-- MEAL PLAN RECIPE CARDS -->

    <!-- ALERT -->
    <app-alert-popup
      *ngIf="showAlert"
      [message]="alertMessage"
      [duration]="alertDuration"
      [status]="alertStatus"
      (close)="closeAlert()"
    ></app-alert-popup>

    <!-- CHOSEN PRODUCTS VIEW -->
    <ng-container *ngIf="showOnlyChosen">
      <h2>{{'resultsScreen.chosenProducts' | translate}}</h2>
      <p *ngIf="chosenProducts.length === 0">No chosen products yet.</p>
      <div class="chosen-products-card" *ngIf="chosenProducts.length > 0">
        <div class="product-grid" *ngIf="!loading">
          <div class="card" *ngFor="let product of products">
            <div class="image-wrapper">
              <img
                [src]="'data:image/jpeg;base64,' + product.imageBase64"
                [alt]="product.name"
              />
              <div class="badge" *ngIf="product.discount">{{'resultsScreen.sale'| translate}}</div>
              <button
                class="fav-btn"
                [class.active]="getAllChosenProducts(product)"
                (click)="toggleChosen(product); loadChosenProducts()"
              >
                ♥
              </button>
            </div>
            <div class="info">
              <h3 class="product-title">{{ product.name }}</h3>
              <p class="product-category" class="category">
                {{ "categories." + product.category | translate }}
              </p>
              <mat-divider></mat-divider>
              <p class="kcal" *ngIf="product.kcal !== null">
                {{ product.kcal }} kcal
              </p>
              <p class="price">{{ product.price | currency : "EUR" }}</p>
            </div>
          </div>
        </div>
      </div>

      <div class="total" *ngIf="chosenProducts.length > 0">
        <strong>{{'resultsScreen.total' | translate}}</strong> {{ totalChosenPrice | currency : "EUR" }}
      </div>

      <!-- Button to handle recipe logic -->
      <!-- <button
        *ngIf="chosenProducts.length > 0"
        (click)="toggleRecipesSection()"
        class="apply-btn"
      >
        Show Meal Plan Recipes
      </button> -->
      <div>
        <div class="day-card" *ngFor="let day of daysList">
          <div class="day-header">
            <h3>{{ day }}</h3>
<button
  class="recipe-btn"
  (click)="generateRecipeForDay(day)"
  [disabled]="loadingRecipes && selectedDayForRecipe === day"
>
  {{
    loadingRecipes && selectedDayForRecipe === day
      ? ('resultsScreen.generating' | translate)
      : ('resultsScreen.showRecipe' | translate)
  }}
</button>
          </div>

          <div class="chosen-products-card">
            <h4>{{'resultsScreen.ingredients'| translate}}</h4>
            <ul>
              <li *ngFor="let cp of getProductsForDay(day)">
                {{ cp.product.name }} -
                {{ cp.product.price | currency : "EUR" }}
              </li>
              <li *ngIf="getProductsForDay(day).length === 0">
               {{'resultsScreen.noChosenProducts'| translate}}
              </li>
            </ul>
          </div>

          <div class="recipe-card" *ngIf="recipeDialogData?.day === day">
            <h4>{{'resultsScreen.recipe'| translate}}</h4>
            <p [innerHTML]="getFormattedRecipe(recipeDialogData?.recipe)"></p>
          </div>
        </div>
      </div>
    </ng-container>
  </main>
</div>
